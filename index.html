<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>宅建模擬試験</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="宅建試験">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%234facfe'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-size='40' fill='white'%3E🏠%3C/text%3E%3C/svg%3E">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 375px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .timer {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 10px;
        }

        .progress-container {
            padding: 0 20px 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .progress {
            background: rgba(255,255,255,0.3);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            background: white;
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .question-container {
            padding: 20px;
            min-height: 400px;
        }

        .question-number {
            background: #f0f8ff;
            color: #4facfe;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            display: inline-block;
        }

        .question-text {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .choices {
            list-style: none;
        }

        .choice {
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .choice.selected {
            border-color: #4facfe;
            background: #e3f2fd;
        }

        .choice label {
            display: block;
            padding: 15px;
            cursor: pointer;
            font-size: 1.05em;
            line-height: 1.5;
        }

        .choice input[type="radio"] {
            display: none;
        }

        .choice:active {
            transform: scale(0.98);
        }

        .controls {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }

        .result-screen {
            display: none;
            padding: 20px;
            text-align: center;
        }

        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .score-number {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .feedback {
            font-size: 1.2em;
            margin-top: 15px;
        }

        .answer-review {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            text-align: left;
        }

        .answer-review h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .correct { color: #28a745; }
        .incorrect { color: #dc3545; }

        .start-screen {
            padding: 40px 20px;
            text-align: center;
        }

        .start-screen h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .start-screen p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 30px;
            font-size: 0.95em;
        }

        .exam-info {
            background: #e3f2fd;
            border-left: 4px solid #4facfe;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
        }

        .exam-info h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .exam-info p {
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .settings {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .setting-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            color: #4facfe;
            font-weight: bold;
            border-bottom: 3px solid #4facfe;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .history-screen {
            display: none;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #4facfe;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .weak-points {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .weak-point-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .weak-point-item:last-child {
            border-bottom: none;
        }

        .progress-mini {
            width: 100px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-mini-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .sync-status {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.9em;
        }

        .sync-status.online {
            background: #e8f5e8;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏠 宅建模擬試験</h1>
            <div class="timer" id="timer">制限時間: --:--</div>
        </div>

        <div class="progress-container">
            <div class="progress">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <!-- ナビゲーションタブ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('home')">🏠 ホーム</button>
            <button class="nav-tab" onclick="showTab('history')">📊 学習履歴</button>
        </div>

        <!-- ホーム画面 -->

        <div id="start-screen" class="start-screen">
            <h2>📚 宅建模擬試験</h2>
            <p>2025年度試験対応<br>権利関係・宅建業法・都市計画法を中心とした実戦的な問題で学習しましょう</p>
            
            <div class="exam-info">
                <h4>🏆 2025年度 本試験情報</h4>
                <p>📅 試験日：10月19日（日）13:00-15:00</p>
                <p>📊 出題：50問（権利関係14問・宅建業法20問・法令制限8問・その他8問）</p>
                <p>🎯 合格ライン：例年35点前後（約70%）</p>
            </div>
            
            <div class="settings">
                <div class="setting-item">
                    <label for="question-count">問題数</label>
                    <select id="question-count">
                        <option value="5">5問（約9分）</option>
                        <option value="10" selected>10問（約18分）</option>
                        <option value="20">20問（約35分）</option>
                        <option value="50">50問（本試験形式・120分）</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="question-type">出題分野</label>
                    <select id="question-type">
                        <option value="mixed" selected>全分野ミックス</option>
                        <option value="minpo">民法中心</option>
                        <option value="takken">宅建業法中心</option>
                        <option value="toshikeikaku">都市計画法中心</option>
                    </select>
                </div>
            </div>
            
            <button class="btn" onclick="startQuiz()">📝 試験開始</button>
        </div>

        <div id="quiz-screen" style="display: none;">
            <div class="question-container">
                <div class="question-number" id="question-number">問1</div>
                <div class="question-text" id="question-text">問題文がここに表示されます</div>
                <ul class="choices" id="choices"></ul>
            </div>

            <div class="controls">
                <button class="btn" id="next-btn" onclick="nextQuestion()" disabled>次の問題へ</button>
                <button class="btn secondary" onclick="endQuiz()">試験終了</button>
            </div>
        </div>

        <div id="result-screen" class="result-screen">
            <div class="score-display">
                <h2>📊 試験結果</h2>
                <div class="score-number" id="final-score">0/0</div>
                <div id="percentage">0%</div>
                <div class="feedback" id="feedback">頑張りましょう！</div>
            </div>

            <div id="answer-review"></div>

            <button class="btn" onclick="resetQuiz()">🔄 もう一度挑戦</button>
        </div>

        <!-- 学習履歴画面 -->
        <div id="history-screen" class="history-screen">
            <div class="sync-status" id="sync-status">
                🔄 データ同期中...
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-attempts">0</div>
                    <div class="stat-label">受験回数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="average-score">0%</div>
                    <div class="stat-label">平均正答率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="best-score">0%</div>
                    <div class="stat-label">最高得点</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="study-time">0h</div>
                    <div class="stat-label">累計学習時間</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>📈 正答率推移</h3>
                <div id="score-chart">グラフがここに表示されます</div>
            </div>

            <div class="weak-points">
                <h3>🎯 弱点分野分析</h3>
                <div id="weak-points-list">
                    データを収集中...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase設定
        var firebaseConfig = {
            apiKey: "AIzaSyDGfHCQX8qTytSEKv_-JWll0_vj6Psci5I",
            authDomain: "takken-quiz-app-d5319.firebaseapp.com",
            projectId: "takken-quiz-app-d5319",
            storageBucket: "takken-quiz-app-d5319.firebasestorage.app",
            messagingSenderId: "328522134398",
            appId: "1:328522134398:web:e71ca705b7612120c7392f",
            measurementId: "G-016EYQ8H8D"
        };

        // Firebase初期化
        if (typeof firebase !== 'undefined') {
            try {
                firebase.initializeApp(firebaseConfig);
                var db = firebase.firestore();
                var isFirebaseReady = true;
                console.log('Firebase初期化成功');
            } catch (error) {
                console.log('Firebase初期化エラー:', error);
                var isFirebaseReady = false;
            }
        } else {
            console.log('Firebase SDK未読み込み');
            var isFirebaseReady = false;
        }

        // ユーザーID生成（デバイス固有）
        var userId = localStorage.getItem('takkenUserId');
        if (!userId) {
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('takkenUserId', userId);
        }
        var questionDatabase = [
            {
                id: 1,
                category: "民法・物権変動",
                question: "AがBに土地を売却し、BがCに転売した場合について正しいものはどれか。",
                choices: [
                    "Bが登記を受けていない場合、CはAに所有権を主張できない",
                    "AB間契約が無効でも、Cが善意無過失なら所有権を取得する",
                    "Cが登記を受けた後なら、AB間契約が取り消されてもCの権利に影響しない",
                    "Bが代金未払いの場合、Cが代金支払い義務を承継する"
                ],
                correct: 2,
                explanation: "民法94条2項の類推適用により、善意のCは保護されます。"
            },
            {
                id: 2,
                category: "宅建業法・重要事項説明",
                question: "重要事項説明に関して正しいものはどれか。",
                choices: [
                    "契約成立後でも相手方の同意があれば説明できる",
                    "宅建士以外でも説明することができる",
                    "契約締結前に説明し、書面を交付しなければならない",
                    "口頭での説明のみで書面交付は不要"
                ],
                correct: 2,
                explanation: "35条により、契約締結前の説明と書面交付が義務付けられています。"
            },
            {
                id: 3,
                category: "宅建業法・8つの制限",
                question: "損害賠償の予定額について正しいものはどれか。",
                choices: [
                    "代金額の30%まで予定できる",
                    "違約金と合算して代金額の20%以下でなければならない",
                    "損害賠償の予定のみなら代金額の50%まで可能",
                    "違約金とは別に代金額の20%まで予定できる"
                ],
                correct: 1,
                explanation: "損害賠償予定額と違約金は合算して代金額の20%以下でなければなりません。"
            },
            {
                id: 4,
                category: "都市計画法・開発行為",
                question: "開発行為について正しいものはどれか。",
                choices: [
                    "市街化区域内では1000平方メートル以上で開発許可が必要",
                    "開発工事完了前でも建築工事を開始できる",
                    "工事完了公告がされるまで建築してはならない",
                    "市街化調整区域では面積に関係なく許可不要"
                ],
                correct: 2,
                explanation: "工事完了公告により建築可能な宅地が完成してから建築工事が可能です。"
            },
            {
                id: 5,
                category: "借地借家法・定期借地権",
                question: "事業用定期借地権について正しいものはどれか。",
                choices: [
                    "存続期間に制限はない",
                    "居住用建物も建築できる",
                    "居住の用に供する建物を建築してはならない",
                    "普通の書面契約で足りる"
                ],
                correct: 2,
                explanation: "事業用定期借地権は居住用建物の建築が禁止されています。"
            },
            {
                id: 6,
                category: "民法・契約不適合責任",
                question: "契約不適合責任について正しいものはどれか。",
                choices: [
                    "買主は不適合を知った時から1年以内に通知が必要",
                    "売主悪意の場合も1年以内に通知が必要",
                    "追完請求なしに直ちに解除できる",
                    "損害賠償と解除は併用できない"
                ],
                correct: 0,
                explanation: "買主は不適合を知った時から1年以内の通知が必要ですが、売主悪意の場合は例外です。"
            },
            {
                id: 7,
                category: "宅建業法・免許制度",
                question: "免許換えについて正しいものはどれか。",
                choices: [
                    "新旧両方の免許を並行して保有できる",
                    "事業を一時停止する必要がある",
                    "新免許取得後、旧免許は効力を失う",
                    "免許番号は引き継がれる"
                ],
                correct: 2,
                explanation: "免許換えでは新免許取得と同時に旧免許は効力を失います。"
            },
            {
                id: 8,
                category: "民法・時効",
                question: "取得時効について正しいものはどれか。",
                choices: [
                    "善意無過失なら10年、その他は20年で取得",
                    "占有開始時の善意無過失で判断される",
                    "盗品は善意でも時効取得できない",
                    "所有の意思は不要"
                ],
                correct: 1,
                explanation: "取得時効は占有開始時の善意無過失で期間が決まります。"
            },
            {
                id: 9,
                category: "宅建業法・仲介手数料",
                question: "賃貸仲介の報酬について正しいものはどれか。",
                choices: [
                    "貸主借主それぞれから1ヶ月分受領できる",
                    "双方から受領する場合は合計で賃料1.1ヶ月分以内",
                    "借主承諾があれば借主から1.1ヶ月分受領できる",
                    "報酬に上限はない"
                ],
                correct: 1,
                explanation: "賃貸仲介では双方合計で賃料1.1ヶ月分（税込）が上限です。"
            },
            {
                id: 10,
                category: "民法・代理",
                question: "代理について正しいものはどれか。",
                choices: [
                    "本人が行為能力者なら代理人は未成年者でもよい",
                    "復代理人選任には本人の許可が必要",
                    "表見代理では本人は効果を否認できる",
                    "無権代理人の相続で必ず有効になる"
                ],
                correct: 0,
                explanation: "代理人の行為能力は問題となりません。本人が行為能力者であれば代理人は未成年者でも構いません。"
            },
            {
                id: 11,
                category: "都市計画法・用途地域",
                question: "第一種低層住居専用地域について正しいものはどれか。",
                choices: [
                    "コンビニエンスストアを建築できる",
                    "小規模な事務所は建築できる",
                    "住宅、小学校、診療所などが建築できる",
                    "ファミリーレストランを建築できる"
                ],
                correct: 2,
                explanation: "第一種低層住居専用地域では住宅、小学校、診療所などの建築が可能です。"
            },
            {
                id: 12,
                category: "宅建業法・37条書面",
                question: "37条書面について正しいものはどれか。",
                choices: [
                    "契約成立前に交付する",
                    "宅建士の記名押印は不要",
                    "契約成立後遅滞なく交付する",
                    "口頭での説明で代替できる"
                ],
                correct: 2,
                explanation: "37条書面は契約成立後遅滞なく交付し、宅建士の記名押印が必要です。"
            },
            {
                id: 13,
                category: "民法・相続",
                question: "法定相続分について正しいものはどれか。",
                choices: [
                    "配偶者と子の場合、配偶者1/3、子2/3",
                    "配偶者と子の場合、配偶者1/2、子1/2",
                    "配偶者と親の場合、配偶者1/2、親1/2",
                    "配偶者と兄弟姉妹の場合、配偶者1/2、兄弟姉妹1/2"
                ],
                correct: 1,
                explanation: "配偶者と子の場合、配偶者1/2、子1/2が法定相続分です。"
            },
            {
                id: 14,
                category: "建築基準法・建築確認",
                question: "建築確認について正しいものはどれか。",
                choices: [
                    "木造住宅は建築確認不要",
                    "防火地域内の建築物は全て建築確認が必要",
                    "増築は建築確認不要",
                    "都市計画区域外では建築確認不要"
                ],
                correct: 1,
                explanation: "防火地域内の建築物は規模に関係なく建築確認が必要です。"
            },
            {
                id: 15,
                category: "宅建業法・業務上の規制",
                question: "宅建業者の業務について正しいものはどれか。",
                choices: [
                    "広告の開始時期に制限はない",
                    "契約締結等の時期の制限はない",
                    "開発許可前は広告してはならない",
                    "宅建士の設置義務はない"
                ],
                correct: 2,
                explanation: "開発許可前の広告は禁止されています（広告の開始時期の制限）。"
            },
            {
                id: 16,
                category: "民法・抵当権",
                question: "抵当権について正しいものはどれか。",
                choices: [
                    "設定には登記が効力要件",
                    "被担保債権が消滅すれば抵当権も消滅する",
                    "抵当権者は抵当不動産を占有できる",
                    "転抵当は禁止されている"
                ],
                correct: 1,
                explanation: "抵当権は被担保債権の消滅とともに消滅します（付従性）。"
            },
            {
                id: 17,
                category: "借地借家法・借家",
                question: "建物の賃貸借について正しいものはどれか。",
                choices: [
                    "存続期間を1年未満と定めた場合、期間の定めのない契約となる",
                    "更新拒絶には正当事由は不要",
                    "定期建物賃貸借は口約束でも有効",
                    "賃借人は無断で転貸できる"
                ],
                correct: 0,
                explanation: "建物賃貸借で存続期間を1年未満と定めた場合、期間の定めのない契約とみなされます。"
            },
            {
                id: 18,
                category: "国土利用計画法・土地取引規制",
                question: "国土利用計画法について正しいものはどれか。",
                choices: [
                    "事前届出は不要",
                    "市街化区域では2000平方メートル以上で事後届出が必要",
                    "事後届出期限は契約締結から2週間以内",
                    "価格についての勧告に強制力はない"
                ],
                correct: 2,
                explanation: "土地売買等の事後届出は契約締結から2週間以内に行う必要があります。"
            },
            {
                id: 19,
                category: "宅建業法・監督処分",
                question: "宅建業者に対する監督処分について正しいものはどれか。",
                choices: [
                    "指示処分に聴聞は不要",
                    "業務停止処分の期間は最長2年",
                    "免許取消後の欠格期間は5年",
                    "処分権者は国土交通大臣のみ"
                ],
                correct: 2,
                explanation: "免許取消処分を受けた場合、5年間は宅建業の免許を受けることができません。"
            },
            {
                id: 20,
                category: "民法・売買契約",
                question: "売買契約について正しいものはどれか。",
                choices: [
                    "売主の担保責任は任意規定",
                    "他人物売買は無効",
                    "危険負担は買主が負う",
                    "解除権に期間制限はない"
                ],
                correct: 0,
                explanation: "売主の担保責任（契約不適合責任）は任意規定なので、特約で排除・軽減できます。"
            },
            {
                id: 21,
                category: "都市計画法・都市計画区域",
                question: "都市計画区域について正しいものはどれか。",
                choices: [
                    "市街化区域と市街化調整区域に必ず区分される",
                    "準都市計画区域は都市計画区域に含まれる",
                    "都道府県が指定する",
                    "用途地域は全域に定められる"
                ],
                correct: 2,
                explanation: "都市計画区域は都道府県が指定します。"
            },
            {
                id: 22,
                category: "宅建業法・クーリングオフ",
                question: "クーリングオフについて正しいものはどれか。",
                choices: [
                    "申込みから8日以内に行使",
                    "事務所で契約した場合も適用される",
                    "書面により行使する",
                    "損害賠償を請求されることがある"
                ],
                correct: 2,
                explanation: "クーリングオフは書面により行使し、買主は損害賠償や違約金の支払いを求められません。"
            },
            {
                id: 23,
                category: "民法・債務不履行",
                question: "債務不履行について正しいものはどれか。",
                choices: [
                    "履行不能の場合、催告は不要",
                    "履行遅滞には催告が必要",
                    "不完全履行では解除できない",
                    "損害賠償請求には解除が前提"
                ],
                correct: 0,
                explanation: "履行不能の場合は催告なしに直ちに契約解除できます。"
            },
            {
                id: 24,
                category: "建築基準法・用途制限",
                question: "建築基準法の用途制限について正しいものはどれか。",
                choices: [
                    "住居系用途地域では事務所は建築できない",
                    "商業地域では全ての建築物が建築できる",
                    "工業専用地域では住宅は建築できない",
                    "用途制限に違反しても建築確認は下りる"
                ],
                correct: 2,
                explanation: "工業専用地域では住宅の建築は禁止されています。"
            },
            {
                id: 25,
                category: "宅建業法・媒介契約",
                question: "媒介契約について正しいものはどれか。",
                choices: [
                    "専属専任媒介契約の有効期間は最長6か月",
                    "一般媒介契約も書面化が義務",
                    "専任媒介契約では2週間に1回以上の報告義務",
                    "依頼者は理由なく契約を解除できない"
                ],
                correct: 1,
                explanation: "媒介契約は種類を問わず書面で締結することが義務付けられています。"
            },
            {
                id: 26,
                category: "民法・保証",
                question: "保証について正しいものはどれか。",
                choices: [
                    "保証契約は口約束でも有効",
                    "連帯保証人は催告の抗弁権がある",
                    "保証債務は書面によらなければ無効",
                    "主債務者の破産で保証債務も消滅"
                ],
                correct: 2,
                explanation: "保証契約は書面または電磁的記録によらなければ効力を生じません。"
            },
            {
                id: 27,
                category: "農地法・農地転用",
                question: "農地転用について正しいものはどれか。",
                choices: [
                    "4ha以下の農地転用は都道府県知事が許可",
                    "農地の売買には農業委員会の許可が必要",
                    "市街化区域内の農地転用は許可不要",
                    "転用目的での農地取得に制限はない"
                ],
                correct: 1,
                explanation: "農地の売買には農業委員会の許可が必要です（農地法3条）。"
            },
            {
                id: 28,
                category: "宅建業法・宅建士",
                question: "宅建士について正しいものはどれか。",
                choices: [
                    "登録は試験合格と同時に自動的に行われる",
                    "事務禁止処分中も宅建士証の携帯は必要",
                    "宅建士証の有効期間は5年",
                    "登録の移転は転居の際に必要"
                ],
                correct: 2,
                explanation: "宅建士証の有効期間は5年で、更新には法定講習の受講が必要です。"
            },
            {
                id: 29,
                category: "民法・賃貸借",
                question: "賃貸借について正しいものはどれか。",
                choices: [
                    "賃借人の修繕権行使に制限はない",
                    "賃料不払いがあっても直ちに解除はできない",
                    "転貸は賃貸人の承諾なしに自由にできる",
                    "賃貸借契約に存続期間の制限はない"
                ],
                correct: 1,
                explanation: "賃料不払いによる解除には信頼関係破壊が必要で、直ちに解除はできません。"
            },
            {
                id: 30,
                category: "土地区画整理法",
                question: "土地区画整理事業について正しいものはどれか。",
                choices: [
                    "換地処分により従前地の権利は消滅する",
                    "仮換地の指定に不服申立てはできない",
                    "保留地は組合員にのみ譲渡できる",
                    "減価補償金の支払い義務はない"
                ],
                correct: 0,
                explanation: "換地処分により従前地の権利は消滅し、換地に権利が移行します。"
            },
            {
                id: 31,
                category: "宅建業法・業者間取引",
                question: "宅建業者間の取引について正しいものはどれか。",
                choices: [
                    "重要事項説明は不要",
                    "37条書面の交付は不要",
                    "クーリングオフは適用されない",
                    "8つの制限は全て適用されない"
                ],
                correct: 2,
                explanation: "宅建業者間取引ではクーリングオフは適用されません。"
            },
            {
                id: 32,
                category: "民法・不法行為",
                question: "不法行為について正しいものはどれか。",
                choices: [
                    "故意がなくても不法行為は成立する",
                    "損害賠償請求権の時効は損害発生から3年",
                    "精神的損害は賠償の対象外",
                    "未成年者は不法行為責任を負わない"
                ],
                correct: 0,
                explanation: "不法行為は故意・過失があれば成立し、過失のみでも成立します。"
            },
            {
                id: 33,
                category: "建築基準法・道路",
                question: "建築基準法の道路について正しいものはどれか。",
                choices: [
                    "幅員は4m以上必要",
                    "建築物の敷地は道路に1m以上接する必要がある",
                    "私道は建築基準法上の道路に該当しない",
                    "位置指定道路は特定行政庁が指定する"
                ],
                correct: 3,
                explanation: "位置指定道路（42条1項5号道路）は特定行政庁が位置を指定します。"
            },
            {
                id: 34,
                category: "宅建業法・広告規制",
                question: "宅建業者の広告について正しいものはどれか。",
                choices: [
                    "開発許可申請中でも広告できる",
                    "建築確認申請中でも広告できる",
                    "必要な許可等を受けた後でなければ広告できない",
                    "広告の開始時期に制限はない"
                ],
                correct: 2,
                explanation: "開発許可や建築確認など必要な許可等を受けた後でなければ広告できません。"
            },
            {
                id: 35,
                category: "民法・委任",
                question: "委任について正しいものはどれか。",
                choices: [
                    "委任は要物契約である",
                    "受任者は善管注意義務を負う",
                    "委任契約の解除には正当事由が必要",
                    "報酬請求権は当然に発生する"
                ],
                correct: 1,
                explanation: "受任者は善良な管理者の注意をもって委任事務を処理する義務を負います。"
            },
            {
                id: 36,
                category: "不動産取得税",
                question: "不動産取得税について正しいものはどれか。",
                choices: [
                    "相続による取得には課税される",
                    "法人の取得には課税されない",
                    "新築住宅には軽減措置がある",
                    "取得から1年以内に申告が必要"
                ],
                correct: 2,
                explanation: "新築住宅には床面積等の要件を満たせば軽減措置があります。"
            },
            {
                id: 37,
                category: "宅建業法・手付金等保全措置",
                question: "手付金等の保全措置について正しいものはどれか。",
                choices: [
                    "売主が宅建業者の場合、常に保全措置が必要",
                    "未完成物件では代金の5%を超える場合に必要",
                    "完成物件では代金の10%を超える場合に必要",
                    "保全措置の方法に制限はない"
                ],
                correct: 2,
                explanation: "完成物件では手付金等が代金の10%を超える場合に保全措置が必要です。"
            },
            {
                id: 38,
                category: "民法・請負",
                question: "請負について正しいものはどれか。",
                choices: [
                    "注文者は理由なく契約を解除できる",
                    "請負人の報酬請求権は仕事完成時に発生",
                    "請負人の担保責任期間は1年",
                    "注文者の危険負担は仕事完成まで"
                ],
                correct: 0,
                explanation: "注文者は損害賠償をすれば理由なく請負契約を解除できます。"
            },
            {
                id: 39,
                category: "都市計画法・地区計画",
                question: "地区計画について正しいものはどれか。",
                choices: [
                    "都市計画区域外でも定めることができる",
                    "市町村が都市計画で定める",
                    "建築確認の際にチェックされない",
                    "住民の意見を聞く必要はない"
                ],
                correct: 1,
                explanation: "地区計画は市町村が都市計画で定めます。"
            },
            {
                id: 40,
                category: "宅建業法・瑕疵担保責任",
                question: "宅建業者が売主の場合の瑕疵担保責任について正しいものはどれか。",
                choices: [
                    "責任期間を10年とする特約は有効",
                    "責任を完全に免除する特約は有効",
                    "引渡しから2年間は責任を負う",
                    "買主が宅建業者の場合は責任を負わない"
                ],
                correct: 2,
                explanation: "宅建業者が売主の場合、引渡しから2年間は担保責任を負います。"
            },
            {
                id: 41,
                category: "民法・占有",
                question: "占有について正しいものはどれか。",
                choices: [
                    "占有の態様に制限はない",
                    "善意の占有者は果実を取得できる",
                    "占有改定は現実の引渡しが必要",
                    "占有の承継は認められない"
                ],
                correct: 1,
                explanation: "善意の占有者は占有物から生じた果実を取得することができます。"
            },
            {
                id: 42,
                category: "固定資産税",
                question: "固定資産税について正しいものはどれか。",
                choices: [
                    "賦課期日は毎年4月1日",
                    "住宅用地には軽減措置がある",
                    "新築住宅に軽減措置はない",
                    "納税義務者は使用者"
                ],
                correct: 1,
                explanation: "住宅用地については税額の軽減措置があります。"
            },
            {
                id: 43,
                category: "宅建業法・従業者名簿",
                question: "従業者名簿について正しいものはどれか。",
                choices: [
                    "従業者の写真を貼付する必要がある",
                    "取引関係者は閲覧を請求できる",
                    "宅建士でない従業者は記載不要",
                    "本店にのみ備え置けば足りる"
                ],
                correct: 1,
                explanation: "従業者名簿は取引の関係者が閲覧を請求できます。"
            },
            {
                id: 44,
                category: "民法・相隣関係",
                question: "相隣関係について正しいものはどれか。",
                choices: [
                    "境界から1m未満の建築は制限される",
                    "隣地使用権は所有者の承諾が必要",
                    "雨水の自然流下は妨げられない",
                    "境界標の設置費用は単独で負担"
                ],
                correct: 2,
                explanation: "雨水その他の自然の流水は、隣地に自然に流下させることができます。"
            },
            {
                id: 45,
                category: "建築基準法・防火",
                question: "建築基準法の防火規定について正しいものはどれか。",
                choices: [
                    "準防火地域内では全て耐火建築物とする",
                    "防火地域内では階数に関係なく耐火建築物とする",
                    "法22条区域では屋根を不燃材料とする",
                    "準耐火建築物は木造では建築できない"
                ],
                correct: 2,
                explanation: "法22条区域では屋根を不燃材料で造る必要があります。"
            },
            {
                id: 46,
                category: "宅建業法・帳簿",
                question: "宅建業者の帳簿について正しいものはどれか。",
                choices: [
                    "各事業年度終了後5年間保存",
                    "取引関係者のみ閲覧請求可能",
                    "本店にのみ備え置けば足りる",
                    "宅建業に関する取引のみ記載"
                ],
                correct: 0,
                explanation: "帳簿は各事業年度終了後5年間保存する必要があります。"
            },
            {
                id: 47,
                category: "民法・時効の援用",
                question: "時効の援用について正しいものはどれか。",
                choices: [
                    "時効は当然に効力を生じる",
                    "援用権者に制限はない",
                    "援用は裁判上でなければできない",
                    "時効の利益を受ける者が援用できる"
                ],
                correct: 3,
                explanation: "時効は時効の利益を受ける者が援用することができます。"
            },
            {
                id: 48,
                category: "印紙税",
                question: "印紙税について正しいものはどれか。",
                choices: [
                    "不動産売買契約書には印紙の貼付が必要",
                    "契約金額に関係なく税額は一定",
                    "電子契約には印紙税が課税される",
                    "印紙の貼付がなくても契約は有効"
                ],
                correct: 3,
                explanation: "印紙の貼付がなくても契約の効力には影響しません。"
            },
            {
                id: 49,
                category: "宅建業法・営業保証金",
                question: "営業保証金について正しいものはどれか。",
                choices: [
                    "本店1000万円、支店ごとに500万円",
                    "国債での供託はできない",
                    "営業開始後30日以内に供託",
                    "取引相手が宅建業者でも還付される"
                ],
                correct: 0,
                explanation: "営業保証金は本店1000万円、支店ごとに500万円を供託します。"
            },
            {
                id: 50,
                category: "民法・危険負担",
                question: "危険負担について正しいものはどれか。",
                choices: [
                    "売買では買主が危険を負担する",
                    "特定物の売買では売主が危険を負担する",
                    "債権者の責めに帰すべき事由があれば債務者の責任",
                    "危険負担の移転時期は引渡時"
                ],
                correct: 0,
                explanation: "売買契約では、原則として買主が危険を負担します。"
            }
        ];

        var currentQuiz = [];
        var currentQuestionIndex = 0;
        var userAnswers = [];
        var startTime;
        var timerInterval;
        var selectedQuestionCount = 10;
        var timeLimit;

        function shuffleArray(array) {
            var shuffled = array.slice();
            for (var i = shuffled.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = shuffled[i];
                shuffled[i] = shuffled[j];
                shuffled[j] = temp;
            }
            return shuffled;
        }

        function startQuiz() {
            selectedQuestionCount = parseInt(document.getElementById('question-count').value);
            
            if (selectedQuestionCount === 50) {
                timeLimit = 120 * 60;
            } else {
                timeLimit = selectedQuestionCount * 1.8 * 60;
            }
            
            currentQuiz = shuffleArray(questionDatabase).slice(0, Math.min(selectedQuestionCount, questionDatabase.length));
            currentQuestionIndex = 0;
            userAnswers = [];
            
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'block';
            document.getElementById('result-screen').style.display = 'none';
            
            startTime = Date.now();
            startTimer();
            displayQuestion();
        }

        function startTimer() {
            var timeLeft = timeLimit;
            
            timerInterval = setInterval(function() {
                timeLeft--;
                var minutes = Math.floor(timeLeft / 60);
                var seconds = timeLeft % 60;
                document.getElementById('timer').textContent = 
                    '残り時間: ' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert('時間切れです！');
                    endQuiz();
                }
                
                if (timeLeft <= 300) {
                    document.getElementById('timer').style.background = 'rgba(255, 59, 48, 0.8)';
                }
            }, 1000);
        }

        function displayQuestion() {
            var question = currentQuiz[currentQuestionIndex];
            document.getElementById('question-number').textContent = 
                '問' + (currentQuestionIndex + 1) + '【' + question.category + '】';
            document.getElementById('question-text').textContent = question.question;
            
            var choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';
            
            for (var i = 0; i < question.choices.length; i++) {
                var li = document.createElement('li');
                li.className = 'choice';
                li.innerHTML = '<input type="radio" name="answer" value="' + i + '" id="choice' + i + '">' +
                              '<label for="choice' + i + '">' + (i + 1) + '. ' + question.choices[i] + '</label>';
                li.addEventListener('click', createClickHandler(i));
                choicesContainer.appendChild(li);
            }
            
            updateProgress();
            document.getElementById('next-btn').disabled = true;
        }

        function createClickHandler(index) {
            return function() {
                selectAnswer(index);
            };
        }

        function selectAnswer(selectedIndex) {
            var choices = document.querySelectorAll('.choice');
            for (var i = 0; i < choices.length; i++) {
                choices[i].classList.remove('selected');
            }
            
            choices[selectedIndex].classList.add('selected');
            document.getElementById('choice' + selectedIndex).checked = true;
            
            document.getElementById('next-btn').disabled = false;
            
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function nextQuestion() {
            var selectedAnswer = document.querySelector('input[name="answer"]:checked');
            if (selectedAnswer) {
                userAnswers[currentQuestionIndex] = parseInt(selectedAnswer.value);
            }
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex < currentQuiz.length) {
                displayQuestion();
            } else {
                endQuiz();
            }
        }

        function updateProgress() {
            var progress = ((currentQuestionIndex + 1) / currentQuiz.length) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function endQuiz() {
            clearInterval(timerInterval);
            
            var selectedAnswer = document.querySelector('input[name="answer"]:checked');
            if (selectedAnswer && currentQuestionIndex < currentQuiz.length) {
                userAnswers[currentQuestionIndex] = parseInt(selectedAnswer.value);
            }
            
            showResults();
        }

        function showResults() {
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            
            var correctCount = 0;
            var wrongAnswers = [];
            for (var i = 0; i < currentQuiz.length; i++) {
                if (userAnswers[i] === currentQuiz[i].correct) {
                    correctCount++;
                } else {
                    wrongAnswers.push({
                        questionId: currentQuiz[i].id,
                        category: currentQuiz[i].category,
                        userAnswer: userAnswers[i],
                        correctAnswer: currentQuiz[i].correct,
                        explanation: currentQuiz[i].explanation
                    });
                }
            }
            
            var percentage = Math.round((correctCount / currentQuiz.length) * 100);
            var timeSpent = Math.round((Date.now() - startTime) / 1000);
            
            // 学習データを記録（ブラウザのlocalStorageに保存）
            var resultData = {
                timestamp: new Date().toISOString(),
                totalQuestions: currentQuiz.length,
                correctCount: correctCount,
                percentage: percentage,
                timeSpent: timeSpent,
                wrongAnswers: wrongAnswers
            };
            
            // 学習データをFirebaseに保存
            saveResultToFirebase(resultData);
            
            // 過去の結果と合わせてローカルにも保存（オフライン対応）
            var allResults = JSON.parse(localStorage.getItem('takkenResults') || '[]');
            allResults.push(resultData);
            localStorage.setItem('takkenResults', JSON.stringify(allResults));
            
            document.getElementById('final-score').textContent = correctCount + '/' + currentQuiz.length;
            document.getElementById('percentage').textContent = percentage + '%';
            
            var feedback = '';
            if (selectedQuestionCount === 50) {
                if (percentage >= 70) {
                    feedback = '🎉 合格！素晴らしい結果です！';
                } else if (percentage >= 65) {
                    feedback = '📚 合格まであと少し！';
                } else if (percentage >= 60) {
                    feedback = '💪 基礎固めを頑張りましょう！';
                } else {
                    feedback = '📖 継続学習で必ず上達します！';
                }
            } else {
                if (percentage >= 80) {
                    feedback = '🎉 素晴らしい！合格圏内です！';
                } else if (percentage >= 70) {
                    feedback = '📚 合格まであと一歩！';
                } else if (percentage >= 60) {
                    feedback = '💪 基礎固めを頑張りましょう！';
                } else {
                    feedback = '📖 継続学習で必ず上達します！';
                }
            }
            
            // 弱点があれば追加メッセージ
            if (wrongAnswers.length > 0) {
                feedback += '<br><small>※ 間違えた分野の類似問題が今後優先出題されます</small>';
            }
            
            document.getElementById('feedback').innerHTML = feedback;
            
            var reviewContainer = document.getElementById('answer-review');
            reviewContainer.innerHTML = '';
            
            for (var i = 0; i < currentQuiz.length; i++) {
                var question = currentQuiz[i];
                var isCorrect = userAnswers[i] === question.correct;
                var userChoice = userAnswers[i] !== undefined ? (userAnswers[i] + 1) + '番' : '未回答';
                var correctChoice = (question.correct + 1) + '番';
                
                var reviewDiv = document.createElement('div');
                reviewDiv.className = 'answer-review';
                
                // 間違えた問題には詳細解説を追加
                var detailedExplanation = question.explanation;
                if (!isCorrect && getDetailedExplanation) {
                    detailedExplanation = getDetailedExplanation(question.id) || question.explanation;
                }
                
                reviewDiv.innerHTML = '<h4>問' + (i + 1) + ' ' + (isCorrect ? '<span class="correct">✅</span>' : '<span class="incorrect">❌</span>') + '</h4>' +
                                     '<p><strong>あなたの回答:</strong> ' + userChoice + '</p>' +
                                     '<p><strong>正解:</strong> ' + correctChoice + '</p>' +
                                     '<p><strong>解説:</strong> ' + detailedExplanation + '</p>';
                reviewContainer.appendChild(reviewDiv);
            }
        }

        // 学習データをFirebaseに保存
        function saveResultToFirebase(resultData) {
            if (!isFirebaseReady) {
                // Firebaseが使えない場合はlocalStorageに保存
                var allResults = JSON.parse(localStorage.getItem('takkenResults') || '[]');
                allResults.push(resultData);
                localStorage.setItem('takkenResults', JSON.stringify(allResults));
                return;
            }

            try {
                db.collection('users').doc(userId).collection('results').add(resultData)
                    .then(function(docRef) {
                        console.log('結果を保存しました:', docRef.id);
                        updateSyncStatus('online');
                    })
                    .catch(function(error) {
                        console.error('保存エラー:', error);
                        // エラー時はlocalStorageにフォールバック
                        var allResults = JSON.parse(localStorage.getItem('takkenResults') || '[]');
                        allResults.push(resultData);
                        localStorage.setItem('takkenResults', JSON.stringify(allResults));
                    });
            } catch (error) {
                console.error('Firebase操作エラー:', error);
            }
        }

        // Firebaseから学習履歴を取得
        function loadHistoryFromFirebase() {
            if (!isFirebaseReady) {
                loadHistoryFromLocalStorage();
                return;
            }

            try {
                db.collection('users').doc(userId).collection('results')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get()
                    .then(function(querySnapshot) {
                        var results = [];
                        querySnapshot.forEach(function(doc) {
                            results.push(doc.data());
                        });
                        displayHistory(results);
                        updateSyncStatus('online');
                    })
                    .catch(function(error) {
                        console.error('履歴取得エラー:', error);
                        loadHistoryFromLocalStorage();
                    });
            } catch (error) {
                console.error('Firebase操作エラー:', error);
                loadHistoryFromLocalStorage();
            }
        }

        // localStorageから履歴を読み込み（フォールバック）
        function loadHistoryFromLocalStorage() {
            var results = JSON.parse(localStorage.getItem('takkenResults') || '[]');
            displayHistory(results);
            updateSyncStatus('offline');
        }

        // 同期状況の更新
        function updateSyncStatus(status) {
            var statusEl = document.getElementById('sync-status');
            if (status === 'online') {
                statusEl.className = 'sync-status online';
                statusEl.textContent = '✅ クラウド同期済み';
            } else {
                statusEl.className = 'sync-status';
                statusEl.textContent = '📱 ローカル保存中（接続時に同期）';
            }
        }

        // タブ切り替え
        function showTab(tabName) {
            // タブボタンの状態更新
            var tabs = document.querySelectorAll('.nav-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            event.target.classList.add('active');

            // 画面の切り替え
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('history-screen').style.display = 'none';

            if (tabName === 'home') {
                document.getElementById('start-screen').style.display = 'block';
            } else if (tabName === 'history') {
                document.getElementById('history-screen').style.display = 'block';
                loadHistoryFromFirebase();
            }
        }

        // 履歴表示
        function displayHistory(results) {
            if (results.length === 0) {
                document.getElementById('weak-points-list').innerHTML = '学習データがありません。試験を受けてみましょう！';
                return;
            }

            // 統計計算
            var totalAttempts = results.length;
            var totalScore = 0;
            var bestScore = 0;
            var totalTime = 0;
            var weakCategories = {};

            for (var i = 0; i < results.length; i++) {
                var result = results[i];
                totalScore += result.percentage || 0;
                bestScore = Math.max(bestScore, result.percentage || 0);
                totalTime += result.timeSpent || 0;

                // 弱点分析
                if (result.wrongAnswers) {
                    for (var j = 0; j < result.wrongAnswers.length; j++) {
                        var wrong = result.wrongAnswers[j];
                        var category = wrong.category || '不明';
                        weakCategories[category] = (weakCategories[category] || 0) + 1;
                    }
                }
            }

            var averageScore = Math.round(totalScore / totalAttempts);

            // 統計表示
            document.getElementById('total-attempts').textContent = totalAttempts;
            document.getElementById('average-score').textContent = averageScore + '%';
            document.getElementById('best-score').textContent = bestScore + '%';
            document.getElementById('study-time').textContent = Math.round(totalTime / 3600) + 'h';

            // 弱点分野表示
            var weakPointsHtml = '';
            var sortedWeakPoints = Object.keys(weakCategories).sort(function(a, b) {
                return weakCategories[b] - weakCategories[a];
            });

            for (var i = 0; i < Math.min(5, sortedWeakPoints.length); i++) {
                var category = sortedWeakPoints[i];
                var count = weakCategories[category];
                var percentage = Math.round((count / totalAttempts) * 100);
                
                weakPointsHtml += '<div class="weak-point-item">' +
                    '<span>' + category + ' (' + count + '回間違い)</span>' +
                    '<div class="progress-mini">' +
                        '<div class="progress-mini-bar" style="width: ' + percentage + '%; background: #ff6b6b;"></div>' +
                    '</div>' +
                '</div>';
            }

            document.getElementById('weak-points-list').innerHTML = weakPointsHtml || '弱点データがありません';
        }

        // 詳細解説を取得する関数
        function getDetailedExplanation(questionId) {
            var detailedExplanations = {
                50: "危険負担とは「契約後、引渡し前に目的物が滅失・毀損した場合の損失を誰が負担するか」の問題です。売買では買主負担が原則。ただし売主の責めに帰すべき事由がある場合は売主負担となります。不動産投資では引渡し前の火災リスク等を考慮する必要があります。",
                44: "相隣関係では、自然の雨水流下は妨げることができません。ただし人工的に雨水を隣地に流すことは不可。境界から1m未満の建築制限、隣地使用権（境界から1m以内の工事時）も重要。不動産投資では隣地トラブル回避のため事前確認が必要です。",
                49: "営業保証金は宅建業開始の要件。本店1000万円、支店1つごとに500万円を法務局に供託。営業保証金協会に加入すれば弁済業務保証金（本店60万円、支店1つ10万円）で代替可能。還付事由が生じれば取引の相手方等に還付されます。",
                36: "不動産取得税の軽減措置：新築住宅は床面積50㎡以上240㎡以下で1200万円控除。中古住宅は築年数等の要件あり。土地は45000円か固定資産税評価額×1/2×3%の少ない方を控除。相続取得は非課税、法人取得は課税対象です。",
                31: "宅建業者間取引では、重要事項説明・37条書面は必要だが、クーリングオフ・手付金等保全措置・瑕疵担保責任の2年間制限は適用外。両者とも宅建のプロなので一般消費者保護規定が除外されます。",
                47: "時効の援用とは「時効が完成したので、その利益を受けます」という意思表示。時効は自動的に効力を生じず、援用が必要。援用権者は時効により直接利益を受ける者（債務者、物上保証人等）。相手方の承諾は不要で、裁判外でも可能です。",
                37: "手付金等保全措置：売主が宅建業者の場合、未完成物件は代金の5%超かつ1000万円超、完成物件は代金の10%超かつ1000万円超で必要。保全方法は銀行保証・保険付保・信託のいずれか。工事完了前引渡しの場合は必ず必要です。",
                48: "印紙税は契約書作成時の税金で、契約の効力とは別問題。印紙を貼らなくても契約は有効だが、印紙税法違反となり過怠税（印紙税額の3倍）が課される。電子契約は課税文書に該当せず印紙税不要。売買代金により税額が決まります。",
                40: "宅建業者売主の場合の担保責任：引渡しから2年間は責任を負う（民法は1年）。これより買主に不利な特約は無効。10年特約は買主に有利なので有効。完全免除特約は無効。ただし宅建業者間取引では適用除外です。",
                23: "債務不履行による解除：履行不能は催告不要で即解除可、履行遅滞・不完全履行は催告が原則必要。ただし催告しても無意味な場合（期限の利益喪失等）は催告不要。解除と損害賠償は併存可能（原状回復＋損害賠償）。",
                38: "請負契約では注文者の任意解除権を認める（民法641条）。ただし請負人の損害を賠償する必要あり。既にした仕事の報酬＋解除により請負人が被る損害を支払えば、理由なく解除可能。建築請負では実務上重要な規定です。",
                45: "建築基準法の防火規制：法22条区域（市街地の外延部等）では屋根を不燃材料とする義務。準防火地域は建物用途・規模で制限が変わる。防火地域は階数・面積問わず耐火建築物または準耐火建築物。防火地域＞準防火地域＞法22条区域の順で制限が厳しい。",
                33: "建築基準法上の道路：幅員4m以上が原則、敷地は2m以上接道が必要。位置指定道路（42条1項5号）は特定行政庁が位置指定する私道。開発道路（42条1項2号）、既存道路（42条1項1号）等と区別。セットバックが必要な2項道路（42条2項）も重要。",
                46: "宅建業者の帳簿：各事業年度終了後5年間保存義務。記載事項は取引年月日、物件所在地、取引態様、取引価格等。従業者名簿は取引関係者の閲覧に供する必要あり。標識は事務所ごとに掲示、専任宅建士の氏名等を記載。"
            };
            
            return detailedExplanations[questionId];
        }

        function resetQuiz() {
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'block';
            document.getElementById('timer').style.background = 'rgba(255,255,255,0.2)';
            document.getElementById('progress-bar').style.width = '0%';
        }
    </script>
</body>
</html>
